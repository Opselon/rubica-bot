name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
      - name: Lint (ruff)
        run: |
          python -m ruff check .
      - name: Unit tests
        run: |
          python -m pytest -m "not e2e and not install"
      - name: Build Docker image
        run: |
          docker build -t rubica-bot:ci .
      - name: Run Docker healthcheck
        run: |
          docker run -d --name rubica-bot -p 18080:8080 \
            -e RUBIKA_BOT_TOKEN=ci-token \
            -e RUBIKA_REGISTER_WEBHOOK=false \
            rubica-bot:ci
          for i in {1..20}; do
            if curl -fsS http://127.0.0.1:18080/health >/dev/null; then
              echo "Healthcheck OK"
              break
            fi
            sleep 1
          done
          curl -fsS http://127.0.0.1:18080/health >/dev/null
          docker logs rubica-bot
          docker rm -f rubica-bot
      - name: Install wizard tests
        run: |
          bash scripts/test_install.sh
      - name: End-to-end tests
        run: |
          python -m pytest -m e2e
      - name: Speed check
        run: |
          python -m app.utils.speedcheck
